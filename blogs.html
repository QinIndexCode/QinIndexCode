<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="QinIndexCode - æŠ€æœ¯åšå®¢ï¼Œåˆ†äº« JavaScriptã€å‰ç«¯å¼€å‘ã€åç«¯å¼€å‘ç­‰æŠ€æœ¯æ–‡ç« ">
    <meta name="keywords" content="æŠ€æœ¯åšå®¢ï¼ŒJavaScript, å‰ç«¯å¼€å‘ï¼Œåç«¯å¼€å‘ï¼ŒReact, Vue, Node.js">
    <title>éšè®° - ä¸ªäººæŠ€æœ¯åšå®¢</title>
    <link href="./css/css2.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/atom-one-dark.min.css">
    <link href="./css/main.css" rel="stylesheet">
    <script src="./js/smooth-scroll.js" defer></script>
    <!-- å¦‚æœç”¨æˆ·ç›´æ¥è®¿é—®æ­¤é¡µé¢ï¼Œè‡ªåŠ¨é‡å®šå‘åˆ° index.html -->
    <script src="./js/redirect-if-standalone.js"></script>
</head>

<body>
    <div class="container" id="container">
        <h1 class="section-title">éšè®°</h1>

        <!-- åšå®¢åˆ—è¡¨ -->
        <div class="grid grid-2" id="blog-list">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- å¼•å…¥ markdown è§£æåº“ -->
    <script src="./js/markdown-it.min.js"></script>
    <script src="./js/highlight.min.js"></script>
    <script>
        const md = window.markdownit({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return '<pre class="hljs"><code>' +
                            hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                            '</code></pre>';
                    } catch (__) { }
                }
                return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
            }
        });

        let blogData = [];

        // ç‚¹èµæ•°æ®å­˜å‚¨ï¼ˆä½¿ç”¨ localStorage ç¼“å­˜ï¼‰
        const likeStorage = {
            getKey: (id) => `blog_like_${id}`,
            hasLiked: (id) => localStorage.getItem(likeStorage.getKey(id)) === 'true',
            setLiked: (id, liked) => localStorage.setItem(likeStorage.getKey(id), liked.toString()),
            getCount: (id) => {
                const data = localStorage.getItem(`blog_like_count_${id}`);
                return data ? parseInt(data, 10) : 0;
            },
            setCount: (id, count) => localStorage.setItem(`blog_like_count_${id}`, count.toString())
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadBlogsSequentially();
        });

        async function loadBlogsSequentially() {
            const blogListElement = document.getElementById('blog-list');
            blogListElement.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            const loadedBlogs = [];
            let index = 1;

            while (true) {
                const fileName = `${index.toString().padStart(3, '0')}.md`;
                const filePath = `./blogs/${fileName}`;

                try {
                    const response = await fetch(filePath, { method: 'HEAD' });
                    if (!response.ok) break;

                    const contentResponse = await fetch(filePath);
                    if (!contentResponse.ok) break;

                    const content = await contentResponse.text();
                    const blog = parseBlogContent(fileName, content);
                    loadedBlogs.push(blog);

                } catch (error) {
                    console.warn(`åœæ­¢åŠ è½½ï¼š${filePath} ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®`);
                    break;
                }

                index++;
            }

            if (loadedBlogs.length === 0) {
                blogListElement.innerHTML = '<div class="empty-state">æš‚æ— åšå®¢æ–‡ç« </div>';
                return;
            }

            blogData = loadedBlogs.sort((a, b) => b.seq - a.seq);
            renderBlogList();
        }

        function parseBlogContent(fileName, content) {
            const seq = parseInt(fileName.replace('.md', ''), 10);

            let title = 'æœªå‘½ååšå®¢';
            let date = 'æœªçŸ¥æ—¥æœŸ';

            const firstLineMatch = content.match(/^##\s+(\d{4}-\d{2}-\d{2})\s+(.*)$/m);
            if (firstLineMatch) {
                date = firstLineMatch[1].trim();
                title = firstLineMatch[2].trim();
            }

            let plainText = content
                .replace(/^##.*$/gm, '')
                .replace(/```[\s\S]*?```/g, '')
                .replace(/!\[.*?\]\(.*?\)/g, '')
                .replace(/\n/g, ' ')
                .trim();

            const excerpt = plainText.length > 150
                ? plainText.substring(0, 150) + '...'
                : plainText || 'æš‚æ— æ‘˜è¦';

            return {
                id: fileName.replace('.md', ''),
                fileName: fileName,
                seq: seq,
                title: title,
                date: date,
                author: 'QinIndexCode',
                excerpt: excerpt,
                content: content
            };
        }

        // ç‚¹èµåŠŸèƒ½å®ç°
        async function loadLikeCount(blogId) {
            const countEl = document.getElementById('like-count');
            const btn = document.getElementById('like-btn');

            // ä» localStorage åŠ è½½ç¼“å­˜æ•°æ®
            const cachedCount = likeStorage.getCount(blogId);
            const hasLiked = likeStorage.hasLiked(blogId);

            if (cachedCount > 0) {
                countEl.textContent = cachedCount;
            }

            if (hasLiked) {
                btn.classList.add('liked');
            }

            // å°è¯•ä» GitHub API è·å–çœŸå®æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
            try {
                // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºè°ƒç”¨ GitHub API è·å– reactions
                // ç›®å‰ä½¿ç”¨ localStorage ä½œä¸ºä¸»è¦å­˜å‚¨
            } catch (error) {
                console.warn('Failed to load likes from GitHub:', error);
            }
        }

        async function toggleLike(blogId) {
            const btn = document.getElementById('like-btn');
            const countEl = document.getElementById('like-count');
            const hasLiked = likeStorage.hasLiked(blogId);

            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½• GitHubï¼ˆå¯é€‰ï¼‰
            // è¿™é‡Œç®€å•å®ç°ï¼Œä½¿ç”¨ localStorage

            if (hasLiked) {
                // å–æ¶ˆç‚¹èµ
                likeStorage.setLiked(blogId, false);
                const currentCount = likeStorage.getCount(blogId);
                likeStorage.setCount(blogId, Math.max(0, currentCount - 1));
                btn.classList.remove('liked');
            } else {
                // æ·»åŠ ç‚¹èµ
                likeStorage.setLiked(blogId, true);
                const currentCount = likeStorage.getCount(blogId);
                likeStorage.setCount(blogId, currentCount + 1);
                btn.classList.add('liked');

                // å°åŠ¨ç”»åé¦ˆ
                btn.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    btn.style.transform = '';
                }, 200);
            }

            // æ›´æ–°æ˜¾ç¤º
            countEl.textContent = likeStorage.getCount(blogId);
        }

        // æ¸²æŸ“åšå®¢åˆ—è¡¨
        function renderBlogList() {
            const container = document.getElementById('container');
            container.classList.add('fade-out');

            setTimeout(() => {
                container.innerHTML = `
                <h1 class="section-title">éšè®°</h1>
                <div class="grid grid-2" id="blog-list"></div>
            `;

                const blogList = document.getElementById('blog-list');
                const blogCardsHTML = blogData.map(blog =>
                    `<div class="card" onclick="openBlog('${blog.id}')" style="cursor: pointer;">
                    <h3>${blog.title}</h3>
                    <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                        <span style="margin-right: 1rem;">${blog.date}</span>
                        <span>${blog.author}</span>
                    </div>
                    <p style="flex: 1; margin-bottom: 1.5rem;">${blog.excerpt}</p>
                    <span class="link-arrow">é˜…è¯»æ›´å¤š</span>
                </div>`
                ).join('');

                blogList.innerHTML = blogCardsHTML;

                container.classList.remove('fade-out');
                container.classList.add('fade-in');
                setTimeout(() => container.classList.remove('fade-in'), 300);
            }, 300);
        }

        function openBlog(blogId) {
            const blog = blogData.find(b => b.id === blogId);
            if (!blog) return;

            const htmlContent = md.render(blog.content);

            // ç”Ÿæˆå”¯ä¸€çš„è®¨è®º IDï¼ˆä½¿ç”¨åšå®¢ IDï¼‰
            const discussionId = blogId;
            const discussionTitle = blog.title;

            const container = document.getElementById('container');
            container.classList.add('fade-out');

            setTimeout(() => {
                container.innerHTML = `
                <button class="back-link" onclick="renderBlogList()">
                    <span class="arrow">â†</span> è¿”å›åˆ—è¡¨
                </button>
                <div class="card blog-detail-card">
                    <!-- åšå®¢å¤´éƒ¨ä¿¡æ¯ -->
                    <div class="blog-header">
                        <h1 class="blog-title">${blog.title}</h1>
                        <div class="blog-meta">
                            <span class="blog-date">ğŸ“… ${blog.date}</span>
                            <span class="blog-author">âœï¸ ${blog.author}</span>
                        </div>
                    </div>
                    
                    <!-- ç‚¹èµå’Œäº’åŠ¨æ  -->
                    <div class="blog-interactions">
                        <button class="like-btn" id="like-btn" onclick="toggleLike('${discussionId}')" aria-label="ç‚¹èµæ–‡ç« ">
                            <svg class="like-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                            <span class="like-count" id="like-count">0</span>
                            <span class="like-text">ç‚¹èµ</span>
                        </button>
                        <div class="interaction-divider"></div>
                        <a href="#comments-section" class="comment-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span>è¯„è®º</span>
                        </a>
                    </div>
                    
                    <!-- åšå®¢æ­£æ–‡ -->
                    <div class="blog-content">
                        ${htmlContent}
                    </div>
                    
                    <!-- æ ‡ç­¾åŒºåŸŸ -->
                    <div class="blog-tags">
                        <span class="tag">#AI</span>
                        <span class="tag">#æŠ€æœ¯æ€è€ƒ</span>
                    </div>
                </div>
                
                <!-- Giscus è¯„è®ºåŒºåŸŸ -->
                <div class="card comments-card" id="comments-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>ğŸ’¬ è¯„è®ºè®¨è®º</h2>
                        <a href="../index.html" class="back-to-main">
                            <span class="arrow">â†</span> è¿”å›ä¸»ç«™
                        </a>
                    </div>
                    <div class="giscus" id="giscus-container"></div>
                </div>`;

                container.classList.remove('fade-out');
                container.classList.add('fade-in');

                // åŠ è½½ç‚¹èµæ•°æ®
                loadLikeCount(discussionId);

                // åŠ¨æ€åŠ è½½ Giscus
                loadGiscus(discussionId);

                // ç›‘å¬ä¸»é¢˜å˜åŒ–
                const observer = new MutationObserver(() => {
                    const giscusFrame = document.querySelector('iframe.giscus-frame');
                    if (giscusFrame && window.getCurrentTheme) {
                        const isDark = !window.getCurrentTheme()['--bg-primary'].includes('#F1F5F9');
                        giscusFrame.contentWindow.postMessage({
                            giscus: {
                                setConfig: {
                                    theme: isDark ? 'dark' : 'light'
                                }
                            }
                        }, 'https://giscus.app');
                    }
                });
                observer.observe(document.body, { attributes: true, attributeFilter: ['style'] });

                setTimeout(() => container.classList.remove('fade-in'), 300);
            }, 300);
        }

        // åŠ¨æ€åŠ è½½ Giscus è¯„è®ºç³»ç»Ÿ
        function loadGiscus(discussionId) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existing = document.querySelector('script[src*="giscus.app"]');
            if (existing) {
                existing.remove();
            }

            // åŒæ—¶ç§»é™¤å¯èƒ½å­˜åœ¨çš„ iframe
            const existingFrame = document.querySelector('iframe.giscus-frame');
            if (existingFrame) {
                existingFrame.remove();
            }

            // æ„å»ºå›è°ƒ URL - ä½¿ç”¨ç»Ÿä¸€çš„ auth-callback.html å¤„ç† OAuth å›è°ƒ
            const backLink = `${window.location.origin}/auth-callback.html?redirect=${encodeURIComponent(window.location.href)}`;

            const script = document.createElement('script');
            script.src = 'https://giscus.app/client.js';
            script.async = true;
            script.crossOrigin = 'anonymous';
            script.setAttribute('data-repo', 'QinIndexCode/QinIndexCode');
            script.setAttribute('data-repo-id', 'R_kgDOQmJfZg');
            script.setAttribute('data-category', 'General');
            script.setAttribute('data-category-id', 'DIC_kwDOQmJfZs4C3dZh');
            script.setAttribute('data-mapping', 'specific');
            script.setAttribute('data-term', discussionId);
            script.setAttribute('data-strict', '0');
            script.setAttribute('data-reactions-enabled', '1');
            script.setAttribute('data-emit-metadata', '0');
            script.setAttribute('data-input-position', 'top');
            script.setAttribute('data-theme', 'preferred_color_scheme');
            script.setAttribute('data-lang', 'zh-CN');
            // è®¾ç½®å›è°ƒé“¾æ¥ï¼Œè®© OAuth åè¿”å›åˆ°ç»Ÿä¸€çš„å¤„ç†é¡µé¢
            script.setAttribute('data-backlink', backLink);
            // ç§»é™¤ lazy loadingï¼Œç¡®ä¿ç«‹å³åŠ è½½
            // script.setAttribute('data-loading', 'lazy');

            // é”™è¯¯å¤„ç†
            script.addEventListener('error', () => {
                console.error('Giscus è„šæœ¬åŠ è½½å¤±è´¥');
                const container = document.getElementById('giscus-container');
                if (container) {
                    container.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
                            <p>è¯„è®ºç³»ç»ŸåŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>
                            <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--accent-blue); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                }
            });

            document.body.appendChild(script);
        }
    </script>
    <style>
        /* åšå®¢è¯¦æƒ…é¡µ Markdown æ ·å¼å¢å¼º */
        .card h1 {
            color: var(--accent-blue);
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            color: var(--accent-purple);
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .card h3 {
            color: var(--text-primary);
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .card ul,
        .card ol {
            margin-left: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }

        .card li {
            margin-bottom: 0.5rem;
        }

        .card pre {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: var(--border-radius);
            overflow-x: auto;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .card code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
        }

        .card p code {
            background: var(--bg-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            color: var(--accent-pink);
        }

        /* Back Link Style */
        .back-link {
            display: inline-flex;
            align-items: center;
            background: none;
            border: none;
            cursor: pointer;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            padding: 0;
            color: var(--accent-blue);
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .back-link:hover {
            color: var(--accent-purple);
            transform: translateX(-4px);
        }

        .back-link .arrow {
            margin-right: 0.5rem;
            font-family: system-ui;
            /* Ensure arrow renders consistently */
        }

        /* Mobile specific fixes */
        @media (max-width: 768px) {
            .container {
                padding-top: 6rem;
                /* Increased top padding to clear fixed hamburger menu */
            }
        }

        /* åšå®¢è¯¦æƒ…é¡µæ ·å¼å¢å¼º */
        .blog-detail-card {
            margin-bottom: 2rem;
        }

        .blog-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .blog-title {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .blog-meta {
            display: flex;
            gap: 1.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .blog-interactions {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .like-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.875rem;
        }

        .like-btn:hover {
            background: var(--glass-bg-hover);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .like-btn.liked {
            background: rgba(236, 72, 153, 0.1);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .like-btn.liked .like-icon {
            fill: var(--accent-pink);
            stroke: var(--accent-pink);
        }

        .like-icon {
            transition: all 0.3s;
        }

        .like-count {
            font-weight: 600;
            min-width: 20px;
        }

        .interaction-divider {
            width: 1px;
            height: 24px;
            background: var(--glass-border);
            margin: 0 0.5rem;
        }

        .comment-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .comment-link:hover {
            color: var(--accent-blue);
            background: var(--glass-bg-hover);
            border-radius: var(--border-radius);
        }

        .blog-content {
            margin-bottom: 2rem;
        }

        .blog-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding-top: 1.5rem;
            border-top: 1px solid var(--glass-border);
        }

        .comments-card {
            margin-top: 2rem;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Giscus å®¹å™¨æ ·å¼ */
        #giscus-container {
            margin-top: 1rem;
        }

        #giscus-container iframe {
            border-radius: var(--border-radius);
        }

        /* è¿”å›ä¸»ç«™é“¾æ¥æ ·å¼ */
        .back-to-main {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .back-to-main:hover {
            background: var(--glass-bg-hover);
            border-color: var(--accent-blue);
            transform: translateX(-4px);
        }

        .back-to-main .arrow {
            font-family: system-ui;
        }
    </style>
</body>

</html>